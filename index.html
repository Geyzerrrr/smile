<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Цветные Башни</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
            user-select: none;
            -webkit-user-select: none;
        }
        
        html, body {
            width: 100vw;
            height: 100vh;
            height: 100dvh;
            overflow: hidden;
            position: fixed;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            font-family: -apple-system, BlinkMacSystemFont, sans-serif;
            color: white;
            display: flex;
            justify-content: center;
            align-items: center;
        }
        
        #app {
            width: 100%;
            height: 100%;
            max-width: 400px;
            max-height: 800px;
            aspect-ratio: 400/800;
            position: relative;
            overflow: hidden;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }
        
        .screen {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            transition: opacity 0.3s;
            z-index: 100;
        }
        
        .start-screen {
            z-index: 200;
        }
        
        .game-screen {
            z-index: 100;
            opacity: 0;
            pointer-events: none;
        }
        
        .level-complete-screen {
            z-index: 150;
            opacity: 0;
            pointer-events: none;
            background: rgba(0, 0, 0, 0.95);
        }
        
        .title {
            font-size: 2.8rem;
            margin-bottom: 0.8rem;
            text-shadow: 0 3px 8px rgba(0, 0, 0, 0.3);
            background: linear-gradient(45deg, #FFD700, #FFA500);
            -webkit-background-clip: text;
            background-clip: text;
            color: transparent;
            font-weight: 900;
            text-align: center;
        }
        
        .subtitle {
            font-size: 1.1rem;
            margin-bottom: 2rem;
            opacity: 0.9;
            text-align: center;
            padding: 0 1.5rem;
            line-height: 1.4;
        }
        
        .btn {
            background: linear-gradient(45deg, #FFD700, #FFA500);
            border: none;
            border-radius: 25px;
            padding: 1rem 2.5rem;
            font-size: 1.3rem;
            font-weight: bold;
            color: #333;
            cursor: pointer;
            margin: 0.5rem;
            transition: transform 0.1s;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
            min-width: 180px;
        }
        
        .btn:active {
            transform: scale(0.95);
        }
        
        .game-header {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 12%;
            min-height: 60px;
            background: rgba(0, 0, 0, 0.6);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0 1.5rem;
            z-index: 90;
            border-bottom: 2px solid rgba(255, 255, 255, 0.2);
        }
        
        .level-container, .moves-container {
            text-align: center;
            flex: 1;
        }
        
        .level-label, .moves-label {
            font-size: 0.8rem;
            opacity: 0.8;
            margin-bottom: 0.2rem;
            font-weight: 600;
        }
        
        .level-value, .moves-value {
            font-size: 1.8rem;
            font-weight: 900;
            color: #FFD700;
        }
        
        #gameContainer {
            position: absolute;
            top: 12%;
            left: 0;
            width: 100%;
            height: 88%;
            z-index: 50;
            overflow: hidden;
            background: linear-gradient(to bottom, rgba(0,0,0,0.15), rgba(0,0,0,0.25));
        }
        
        .towers-container {
            position: absolute;
            width: 100%;
            height: 100%;
            display: flex;
            justify-content: space-around;
            align-items: flex-end;
            padding-bottom: 20px;
        }
        
        .tower {
            position: relative;
            width: 12%;
            height: 85%;
            display: flex;
            flex-direction: column-reverse;
            align-items: center;
            justify-content: flex-start;
        }
        
        .tower-base {
            position: absolute;
            bottom: 0;
            width: 100%;
            height: 10px;
            background: linear-gradient(to top, #8B4513, #A0522D);
            border-radius: 5px;
            z-index: 5;
            box-shadow: 0 -5px 15px rgba(0, 0, 0, 0.5);
        }
        
        .tower-rod {
            position: absolute;
            bottom: 10px;
            width: 8px;
            height: 95%;
            background: linear-gradient(to bottom, #D2691E, #8B4513);
            border-radius: 4px;
            z-index: 4;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.3);
        }
        
        .washer {
            position: relative;
            width: 80%;
            height: 30px;
            margin-bottom: 2px;
            border-radius: 15px;
            z-index: 10;
            transition: all 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            box-shadow: 0 3px 8px rgba(0, 0, 0, 0.3);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .washer:hover {
            filter: brightness(1.1);
        }
        
        .washer.selected {
            transform: translateY(-20px) scale(1.05);
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.5);
            z-index: 20;
        }
        
        .washer-inner {
            width: 60%;
            height: 12px;
            border-radius: 6px;
            background: rgba(255, 255, 255, 0.3);
            box-shadow: inset 0 2px 4px rgba(0, 0, 0, 0.2);
        }
        
        .level-complete-content {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(30px);
            -webkit-backdrop-filter: blur(30px);
            border-radius: 25px;
            padding: 2rem 1.5rem;
            text-align: center;
            width: 80%;
            max-width: 320px;
            border: 1px solid rgba(255, 255, 255, 0.2);
            box-shadow: 0 15px 35px rgba(0, 0, 0, 0.4);
        }
        
        .complete-title {
            font-size: 1.8rem;
            margin-bottom: 1rem;
            color: #FFD700;
        }
        
        .level-moves {
            font-size: 3.5rem;
            margin: 1rem 0;
            color: #FFD700;
            font-weight: 900;
            text-shadow: 0 2px 8px rgba(0,0,0,0.5);
        }
        
        .instruction {
            position: absolute;
            bottom: 10%;
            font-size: 1rem;
            font-weight: bold;
            color: rgba(255, 255, 255, 0.9);
            text-shadow: 0 2px 6px rgba(0,0,0,0.5);
            text-align: center;
            z-index: 60;
            width: 100%;
            padding: 0 1rem;
            background: rgba(0, 0, 0, 0.4);
            border-radius: 15px;
            margin: 0 1rem;
            padding: 0.8rem;
        }
        
        .tower-label {
            position: absolute;
            bottom: -25px;
            font-size: 0.9rem;
            font-weight: bold;
            color: #FFD700;
            text-shadow: 0 2px 4px rgba(0,0,0,0.5);
            width: 100%;
            text-align: center;
        }
        
        @keyframes washerPlace {
            0% { transform: translateY(-20px) scale(1.05); }
            100% { transform: translateY(0) scale(1); }
        }
        
        .washer-place {
            animation: washerPlace 0.3s ease;
        }
        
        @keyframes glow {
            0% { box-shadow: 0 3px 8px rgba(0, 0, 0, 0.3), 0 0 10px currentColor; }
            50% { box-shadow: 0 3px 8px rgba(0, 0, 0, 0.3), 0 0 25px currentColor; }
            100% { box-shadow: 0 3px 8px rgba(0, 0, 0, 0.3), 0 0 10px currentColor; }
        }
        
        .washer.completed {
            animation: glow 1.5s infinite;
        }
        
        .color-preview {
            display: flex;
            justify-content: center;
            gap: 8px;
            margin-top: 15px;
        }
        
        .color-dot {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            border: 2px solid rgba(255, 255, 255, 0.3);
        }
    </style>
</head>
<body>
    <div id="app">
        <div class="screen start-screen" id="startScreen">
            <h1 class="title">ЦВЕТНЫЕ БАШНИ</h1>
            <p class="subtitle">Перемещай шайбы, чтобы на каждой башне остались шайбы только одного цвета!</p>
            <button class="btn" id="startBtn">ИГРАТЬ</button>
            <div class="color-preview">
                <div class="color-dot" style="background: #FF6B6B;"></div>
                <div class="color-dot" style="background: #FFD166;"></div>
                <div class="color-dot" style="background: #06D6A0;"></div>
                <div class="color-dot" style="background: #118AB2;"></div>
                <div class="color-dot" style="background: #7209B7;"></div>
                <div class="color-dot" style="background: #F72585;"></div>
                <div class="color-dot" style="background: #FF9E00;"></div>
            </div>
            <div class="instruction" id="instruction">
                Нажми на шайбу, чтобы выбрать, затем нажми на башню для перемещения
            </div>
        </div>
        
        <div class="screen game-screen" id="gameScreen">
            <div class="game-header">
                <div class="level-container">
                    <div class="level-label">УРОВЕНЬ</div>
                    <div class="level-value" id="levelValue">1</div>
                </div>
                <div class="moves-container">
                    <div class="moves-label">ХОДЫ</div>
                    <div class="moves-value" id="movesValue">0</div>
                </div>
            </div>
            
            <div id="gameContainer">
                <div class="towers-container" id="towersContainer">
                    <!-- 7 башен будут сгенерированы скриптом -->
                </div>
            </div>
        </div>
        
        <div class="screen level-complete-screen" id="levelCompleteScreen">
            <div class="level-complete-content">
                <h2 class="complete-title">УРОВЕНЬ ПРОЙДЕН!</h2>
                <div class="level-moves" id="levelMoves">0</div>
                <p style="opacity: 0.8; margin-bottom: 1.5rem;">Ходов на этом уровне</p>
                <button class="btn" id="nextLevelBtn">СЛЕДУЮЩИЙ УРОВЕНЬ</button>
            </div>
        </div>
    </div>

    <script>
        // Константы игры
        const COLORS = [
            '#FF6B6B', // Красный
            '#FFD166', // Желтый
            '#06D6A0', // Зеленый
            '#118AB2', // Синий
            '#7209B7', // Фиолетовый
            '#F72585', // Розовый
            '#FF9E00'  // Оранжевый
        ];
        
        const WASHER_HEIGHT = 30;
        const WASHER_SPACING = 2;
        const TOWER_MAX_WASHERS = 16;
        const TOWER_COUNT = 7;
        
        // Игровое состояние
        let gameState = {
            level: 1,
            moves: 0,
            selectedWasher: null,
            selectedTower: null,
            washers: [],
            towers: Array(TOWER_COUNT).fill().map(() => []),
            gameActive: false,
            targetColors: [] // Цвет, который должен быть на каждой башне
        };
        
        // DOM элементы
        const startScreen = document.getElementById('startScreen');
        const gameScreen = document.getElementById('gameScreen');
        const levelCompleteScreen = document.getElementById('levelCompleteScreen');
        const levelValue = document.getElementById('levelValue');
        const movesValue = document.getElementById('movesValue');
        const levelMoves = document.getElementById('levelMoves');
        const towersContainer = document.getElementById('towersContainer');
        const app = document.getElementById('app');
        
        // Инициализация
        function init() {
            setupEventListeners();
            createTowers();
            resetGame();
            
            window.addEventListener('resize', updateGameDimensions);
            window.addEventListener('orientationchange', () => {
                setTimeout(updateGameDimensions, 300);
            });
            
            updateGameDimensions();
        }
        
        // Обновление размеров игры
        function updateGameDimensions() {
            // При необходимости можно адаптировать размеры элементов
        }
        
        // Создание башен
        function createTowers() {
            towersContainer.innerHTML = '';
            
            for (let i = 0; i < TOWER_COUNT; i++) {
                const tower = document.createElement('div');
                tower.className = 'tower';
                tower.dataset.index = i;
                
                const towerBase = document.createElement('div');
                towerBase.className = 'tower-base';
                
                const towerRod = document.createElement('div');
                towerRod.className = 'tower-rod';
                
                const towerLabel = document.createElement('div');
                towerLabel.className = 'tower-label';
                towerLabel.textContent = `${i + 1}`;
                
                tower.appendChild(towerBase);
                tower.appendChild(towerRod);
                tower.appendChild(towerLabel);
                
                // Обработчик клика на башню
                tower.addEventListener('click', () => handleTowerClick(i));
                
                towersContainer.appendChild(tower);
            }
        }
        
        // Настройка обработчиков событий
        function setupEventListeners() {
            document.getElementById('startBtn').addEventListener('click', startGame);
            document.getElementById('nextLevelBtn').addEventListener('click', nextLevel);
        }
        
        // Начать игру
        function startGame() {
            resetGame();
            
            startScreen.style.opacity = '0';
            startScreen.style.pointerEvents = 'none';
            levelCompleteScreen.style.opacity = '0';
            levelCompleteScreen.style.pointerEvents = 'none';
            
            setTimeout(() => {
                gameScreen.style.opacity = '1';
                gameScreen.style.pointerEvents = 'auto';
                gameState.gameActive = true;
                
                // Создаем начальное распределение шайб
                setupLevel();
            }, 300);
        }
        
        // Сброс игры
        function resetGame() {
            gameState.level = 1;
            gameState.moves = 0;
            gameState.selectedWasher = null;
            gameState.selectedTower = null;
            gameState.washers = [];
            gameState.towers = Array(TOWER_COUNT).fill().map(() => []);
            gameState.targetColors = [];
            gameState.gameActive = false;
            
            // Удаляем все шайбы
            document.querySelectorAll('.washer').forEach(washer => washer.remove());
            
            updateUI();
        }
        
        // Настройка уровня
        function setupLevel() {
            // Очищаем предыдущие шайбы
            gameState.washers = [];
            gameState.towers = Array(TOWER_COUNT).fill().map(() => []);
            gameState.moves = 0;
            gameState.selectedWasher = null;
            gameState.selectedTower = null;
            gameState.targetColors = [];
            
            // Удаляем старые шайбы из DOM
            document.querySelectorAll('.washer').forEach(washer => washer.remove());
            
            // Определяем количество шайб на уровне
            const washerCount = Math.min(56 + gameState.level * 7, TOWER_COUNT * TOWER_MAX_WASHERS); // Все башни заполнены примерно на 50%
            
            // Создаем шайбы
            createWashers(washerCount);
            
            // Определяем целевые цвета для каждой башни
            determineTargetColors();
            
            // Распределяем шайбы по башням (все башни должны быть заполнены)
            distributeWashers(washerCount);
            
            updateUI();
        }
        
        // Определение целевых цветов для каждой башни
        function determineTargetColors() {
            // Случайным образом распределяем 7 цветов по 7 башням
            const shuffledColors = [...COLORS].sort(() => Math.random() - 0.5);
            gameState.targetColors = shuffledColors;
        }
        
        // Создание шайб
        function createWashers(washerCount) {
            gameState.washers = [];
            
            // Создаем все шайбы
            for (let i = 0; i < washerCount; i++) {
                // Цвет шайбы определяется случайно из 7 цветов
                const colorIndex = Math.floor(Math.random() * COLORS.length);
                
                // Создаем элемент шайбы
                const washer = document.createElement('div');
                washer.className = 'washer';
                washer.dataset.id = i;
                washer.dataset.colorIndex = colorIndex;
                
                // Внутренний элемент для эффекта "шайбы"
                const washerInner = document.createElement('div');
                washerInner.className = 'washer-inner';
                washer.appendChild(washerInner);
                
                // Устанавливаем стили
                washer.style.backgroundColor = COLORS[colorIndex];
                
                // Обработчик клика на шайбу
                washer.addEventListener('click', (e) => {
                    e.stopPropagation();
                    handleWasherClick(i);
                });
                
                gameState.washers.push({
                    id: i,
                    element: washer,
                    colorIndex: colorIndex,
                    tower: -1, // Пока не размещен
                    targetColor: -1 // Будет установлено при распределении
                });
            }
        }
        
        // Распределение шайб по башням (все башни заполнены)
        function distributeWashers(washerCount) {
            // Определяем, сколько шайб должно быть на каждой башне
            // Все башни должны быть заполнены, но неравномерно (в среднем 50% заполнения)
            const minWashersPerTower = Math.floor(TOWER_MAX_WASHERS * 0.3); // 30% заполнения
            const maxWashersPerTower = Math.floor(TOWER_MAX_WASHERS * 0.7); // 70% заполнения
            
            let remainingWashers = washerCount;
            const washersPerTower = [];
            
            // Распределяем базовое количество шайб по башням
            for (let i = 0; i < TOWER_COUNT; i++) {
                // Определяем случайное количество шайб для этой башни
                const targetCount = Math.floor(Math.random() * (maxWashersPerTower - minWashersPerTower + 1)) + minWashersPerTower;
                const actualCount = Math.min(targetCount, Math.max(minWashersPerTower, remainingWashers - (TOWER_COUNT - i - 1) * minWashersPerTower));
                
                washersPerTower[i] = Math.max(minWashersPerTower, Math.min(actualCount, remainingWashers));
                remainingWashers -= washersPerTower[i];
            }
            
            // Если остались лишние шайбы, распределяем их по случайным башням
            while (remainingWashers > 0) {
                const randomTower = Math.floor(Math.random() * TOWER_COUNT);
                if (washersPerTower[randomTower] < TOWER_MAX_WASHERS) {
                    washersPerTower[randomTower]++;
                    remainingWashers--;
                }
            }
            
            // Создаем копию массива шайб для распределения
            let availableWashers = [...gameState.washers];
            
            // Для каждой башни определяем целевой цвет
            const towerTargetColors = [...gameState.targetColors];
            
            // Распределяем шайбы по башням
            for (let towerIndex = 0; towerIndex < TOWER_COUNT; towerIndex++) {
                const targetColorIndex = towerTargetColors[towerIndex];
                const neededWashers = washersPerTower[towerIndex];
                
                // Сначала добавляем шайбы целевого цвета
                let targetColorWashers = [];
                let otherWashers = [];
                
                // Разделяем шайбы по цветам
                for (let i = 0; i < availableWashers.length; i++) {
                    if (availableWashers[i].colorIndex === targetColorIndex) {
                        targetColorWashers.push(availableWashers[i]);
                    } else {
                        otherWashers.push(availableWashers[i]);
                    }
                }
                
                // Определяем, сколько шайб целевого цвета добавить (от 30% до 70% от общего количества)
                const targetColorCount = Math.min(
                    targetColorWashers.length,
                    Math.floor(neededWashers * (0.3 + Math.random() * 0.4))
                );
                
                // Добавляем шайбы целевого цвета
                for (let i = 0; i < targetColorCount; i++) {
                    const washer = targetColorWashers.pop();
                    placeWasherOnTower(washer, towerIndex);
                    availableWashers = availableWashers.filter(w => w.id !== washer.id);
                }
                
                // Добавляем остальные шайбы других цветов
                for (let i = 0; i < neededWashers - targetColorCount; i++) {
                    if (otherWashers.length === 0) break;
                    
                    const randomIndex = Math.floor(Math.random() * otherWashers.length);
                    const washer = otherWashers.splice(randomIndex, 1)[0];
                    placeWasherOnTower(washer, towerIndex);
                    availableWashers = availableWashers.filter(w => w.id !== washer.id);
                }
                
                // Обновляем массив доступных шайб
                availableWashers = [...targetColorWashers, ...otherWashers];
            }
            
            // Если еще остались шайбы, распределяем их случайно
            while (availableWashers.length > 0) {
                const washer = availableWashers.pop();
                const randomTower = Math.floor(Math.random() * TOWER_COUNT);
                if (gameState.towers[randomTower].length < TOWER_MAX_WASHERS) {
                    placeWasherOnTower(washer, randomTower);
                }
            }
            
            // Устанавливаем целевой цвет для каждой шайбы
            gameState.washers.forEach(washer => {
                washer.targetColor = gameState.targetColors[washer.tower];
            });
        }
        
        // Размещение шайбы на башне
        function placeWasherOnTower(washer, towerIndex) {
            washer.tower = towerIndex;
            gameState.towers[towerIndex].push(washer.id);
            
            // Добавляем в DOM
            const towerElement = document.querySelector(`.tower[data-index="${towerIndex}"]`);
            towerElement.insertBefore(washer.element, towerElement.firstChild);
        }
        
        // Обработка клика на шайбу
        function handleWasherClick(washerId) {
            if (!gameState.gameActive) return;
            
            const washer = gameState.washers[washerId];
            const towerIndex = washer.tower;
            const towerWashers = gameState.towers[towerIndex];
            
            // Проверяем, является ли шайба верхней в своей башне
            if (towerWashers.length === 0 || towerWashers[towerWashers.length - 1] !== washerId) {
                // Не верхняя шайба - нельзя выбрать
                washer.element.style.transform = 'translateX(5px)';
                setTimeout(() => {
                    washer.element.style.transform = 'translateX(0)';
                }, 200);
                return;
            }
            
            // Если шайба уже выбрана, отменяем выбор
            if (gameState.selectedWasher === washerId) {
                washer.element.classList.remove('selected');
                gameState.selectedWasher = null;
                gameState.selectedTower = null;
                return;
            }
            
            // Если другая шайба уже выбрана, отменяем ее выбор
            if (gameState.selectedWasher !== null) {
                gameState.washers[gameState.selectedWasher].element.classList.remove('selected');
            }
            
            // Выбираем эту шайбу
            washer.element.classList.add('selected');
            gameState.selectedWasher = washerId;
            gameState.selectedTower = washer.tower;
        }
        
        // Обработка клика на башню
        function handleTowerClick(towerIndex) {
            if (!gameState.gameActive) return;
            
            // Если шайба выбрана, пытаемся переместить ее на эту башню
            if (gameState.selectedWasher !== null) {
                moveSelectedWasherToTower(towerIndex);
            }
        }
        
        // Перемещение выбранной шайбы на указанную башню
        function moveSelectedWasherToTower(targetTowerIndex) {
            const washerId = gameState.selectedWasher;
            const washer = gameState.washers[washerId];
            const sourceTowerIndex = washer.tower;
            
            // Нельзя перемещать шайбу на ту же башню
            if (targetTowerIndex === sourceTowerIndex) {
                return;
            }
            
            // Проверяем, можно ли переместить шайбу на эту башню
            if (!canMoveWasherToTower(washerId, targetTowerIndex)) {
                // Показываем визуальную обратную связь о невозможности перемещения
                const towerElement = document.querySelector(`.tower[data-index="${targetTowerIndex}"]`);
                towerElement.style.transform = 'translateX(5px)';
                setTimeout(() => {
                    towerElement.style.transform = 'translateX(0)';
                }, 100);
                return;
            }
            
            // Перемещаем шайбу
            moveWasherToTower(washerId, targetTowerIndex, true);
            
            // Снимаем выделение
            washer.element.classList.remove('selected');
            gameState.selectedWasher = null;
            gameState.selectedTower = null;
            
            // Увеличиваем счетчик ходов
            gameState.moves++;
            updateUI();
            
            // Проверяем, завершен ли уровень
            checkLevelComplete();
        }
        
        // Проверка, можно ли переместить шайбу на указанную башню
        function canMoveWasherToTower(washerId, targetTowerIndex) {
            const targetTower = gameState.towers[targetTowerIndex];
            
            // Если башня уже заполнена (16 шайб), нельзя перемещать
            if (targetTower.length >= TOWER_MAX_WASHERS) {
                return false;
            }
            
            // В нашей игре можно перемещать любую верхнюю шайбу на любую башню,
            // если там есть место (все шайбы одинакового размера)
            return true;
        }
        
        // Перемещение шайбы на указанную башню
        function moveWasherToTower(washerId, targetTowerIndex, animate = true) {
            const washer = gameState.washers[washerId];
            const sourceTowerIndex = washer.tower;
            
            // Удаляем шайбу из исходной башни
            const sourceTowerArray = gameState.towers[sourceTowerIndex];
            const washerIndex = sourceTowerArray.indexOf(washerId);
            if (washerIndex > -1) {
                sourceTowerArray.splice(washerIndex, 1);
            }
            
            // Добавляем шайбу в целевую башню
            gameState.towers[targetTowerIndex].push(washerId);
            
            // Обновляем свойство шайбы
            washer.tower = targetTowerIndex;
            
            // Перемещаем элемент шайбы в DOM
            const towerElement = document.querySelector(`.tower[data-index="${targetTowerIndex}"]`);
            
            if (animate) {
                // Анимация перемещения
                washer.element.style.transition = 'all 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275)';
                washer.element.classList.add('washer-place');
                
                setTimeout(() => {
                    towerElement.insertBefore(washer.element, towerElement.firstChild);
                    washer.element.classList.remove('washer-place');
                }, 50);
            } else {
                // Без анимации
                towerElement.insertBefore(washer.element, towerElement.firstChild);
            }
        }
        
        // Проверка завершения уровня
        function checkLevelComplete() {
            // Проверяем, что на каждой башне все шайбы одного цвета
            let allTowersUniform = true;
            
            for (let i = 0; i < TOWER_COUNT; i++) {
                const towerWashers = gameState.towers[i];
                
                // Если башня пуста, это ошибка - все башни должны быть заполнены
                if (towerWashers.length === 0) {
                    allTowersUniform = false;
                    break;
                }
                
                // Получаем цвет первой шайбы в башне
                const firstWasherColor = gameState.washers[towerWashers[0]].colorIndex;
                
                // Проверяем, что все шайбы на башне одного цвета
                for (const washerId of towerWashers) {
                    if (gameState.washers[washerId].colorIndex !== firstWasherColor) {
                        allTowersUniform = false;
                        break;
                    }
                }
                
                if (!allTowersUniform) break;
            }
            
            // Уровень пройден!
            if (allTowersUniform) {
                levelComplete();
            }
            
            return allTowersUniform;
        }
        
        // Завершение уровня
        function levelComplete() {
            gameState.gameActive = false;
            
            // Показываем анимацию завершения для всех шайб
            gameState.washers.forEach(washer => {
                washer.element.classList.add('completed');
            });
            
            setTimeout(() => {
                gameScreen.style.opacity = '0';
                gameScreen.style.pointerEvents = 'none';
                
                levelMoves.textContent = gameState.moves;
                levelCompleteScreen.style.opacity = '1';
                levelCompleteScreen.style.pointerEvents = 'auto';
            }, 1000);
        }
        
        // Следующий уровень
        function nextLevel() {
            gameState.level++;
            
            // Убираем анимацию завершения
            gameState.washers.forEach(washer => {
                washer.element.classList.remove('completed');
            });
            
            levelCompleteScreen.style.opacity = '0';
            levelCompleteScreen.style.pointerEvents = 'none';
            
            setTimeout(() => {
                gameScreen.style.opacity = '1';
                gameScreen.style.pointerEvents = 'auto';
                gameState.gameActive = true;
                
                setupLevel();
            }, 300);
        }
        
        // Обновление интерфейса
        function updateUI() {
            levelValue.textContent = gameState.level;
            movesValue.textContent = gameState.moves;
        }
        
        // Инициализация при загрузке
        window.addEventListener('DOMContentLoaded', init);
        
        // Предотвращение масштабирования на мобильных устройствах
        document.addEventListener('touchmove', (e) => {
            e.preventDefault();
        }, { passive: false });
        
        document.addEventListener('gesturestart', (e) => {
            e.preventDefault();
        });
    </script>
</body>

</html>
